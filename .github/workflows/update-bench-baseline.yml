name: Update Bench Baseline

on:
  workflow_dispatch: { }

permissions:
  contents: write

jobs:
  update-baseline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libopenblas-dev
      - name: Run full matmul bench
        run: |
          # Run a full matmul bench (no CI_BENCH) and write estimates
          cargo bench --bench matmul_bench --features openblas
      - name: Compare with baseline (improvement needed)
        run: |
          NEW=target/criterion/matmul/matmul_50x50/new/estimates.json
          BASE=ci/baseline/matmul_50x50_estimates.json
          if [ ! -f "$NEW" ]; then
            echo "New bench estimates not found: $NEW"; exit 1
          fi
          python3 ci/compare_criterion_reports.py "$BASE" "$NEW" "matmul_50x50" 0.1 improve
      - name: Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create branch & update baseline files
        id: set_branch
        run: |
          BRANCH=bench/update-baseline-$(date +%s)
          git checkout -b "$BRANCH"
          cp target/criterion/matmul/matmul_50x50/new/estimates.json ci/baseline/matmul_50x50_estimates.json
          git add ci/baseline/matmul_50x50_estimates.json
          git commit -m "Update matmul_50x50 baseline from benchmark improvements"
          git push --set-upstream origin "$BRANCH"
          echo "name=$BRANCH" >> "$GITHUB_OUTPUT"
      - name: Create PR for baseline update
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update bench baseline: matmul_50x50"
          title: "Update bench baseline: matmul_50x50"
          body: |
            This PR updates the `matmul_50x50` baseline with improvements detected by the benchmark runner.
            Please review the performance changes and merge if acceptable.
          base: main
          branch: ${{ steps.set_branch.outputs.name }}