name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest ]
        features: [ "none", "openblas", "dtype_f16", "dtype_bf16", "with_tokenizers", "safe_tensors", "quantized", "with_tch" ]
        exclude:
          - os: windows-latest
            features: "with_tch"
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install maturin
        run: |
          python -m pip install --upgrade pip
          pip install maturin
      - name: Setup OpenBLAS on Windows
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $openblas = "${{ github.workspace }}\OpenBLAS-0.3.30-x64-64"
          if (Test-Path $openblas) {
            Write-Host "Found OpenBLAS at $openblas"
            "OPENBLAS_DIR=$openblas" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "PATH=$openblas\bin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "LIB=$openblas\lib;$env:LIB" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "OpenBLAS bundle not found in repo; running setup script"
            ./scripts/setup_dev_repo.ps1
            # If the script set session env, also set them in GITHUB_ENV if available
            if ($env:OPENBLAS_DIR) {
              "OPENBLAS_DIR=$env:OPENBLAS_DIR" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "PATH=$env:OPENBLAS_DIR\bin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              "LIB=$env:OPENBLAS_DIR\lib;$env:LIB" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
          }
      - name: Run cargo test
        shell: bash
        run: |
          echo "Matrix features: ${{ matrix.features }}"
          if [ "${{ matrix.features }}" != "none" ]; then
            cargo test --verbose --all-features --features "${{ matrix.features }}" --workspace
          else
            cargo test --verbose --workspace
          fi
      - name: Build Python wheel (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          maturin build --release
      - name: Install Python dev wheel & test deps (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          maturin develop --release --bindings pyo3
          python -m pip install --upgrade pip numpy pytest pytest-timeout
          # Run Python tests (fast) in CI; pytest-timeout will ensure hangs fail the job
          pytest -q
      - name: Run Python LLaVA smoke test (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          python tests/python_llava_smoke.py

  test_with_tch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install maturin
        run: |
          python -m pip install --upgrade pip
          pip install maturin
      - name: Install torch (CPU wheel)
        run: |
          python -m pip install --upgrade pip
          # Use the CPU-only PyTorch wheel for CI to avoid CUDA/driver issues.
          pip install torch --index-url https://download.pytorch.org/whl/cpu
      - name: Run cargo test (with_tch)
        run: |
          cargo test --features "with_tch" --verbose --workspace
      - name: Build Python wheel with_tch
        run: |
          maturin build --release

  python_examples:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest ]
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install maturin & deps
        run: |
          python -m pip install --upgrade pip
          pip install maturin numpy safetensors transformers
      - name: Build Python wheel & run LLaVA smoke test
        run: |
          maturin develop --release --bindings pyo3
          python tests/python_llava_smoke.py
      - name: "Windows: Install Visual Studio Build Tools and VC Runtime"
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # install Visual C++ Redistributable and Build Tools for Windows
          $vc = 'https://aka.ms/vs/17/release/vc_redist.x64.exe'
          Write-Host "Downloading $vc"
          Invoke-WebRequest -Uri $vc -OutFile vc_redist.x64.exe
          Start-Process .\vc_redist.x64.exe -ArgumentList '/install','/quiet','/norestart' -Wait
          # optional: ensure build tools are installed via chocolatey
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) { Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')) }
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --includeRecommended --passive" -y
  test_with_tch_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      - name: Download prebuilt libtorch for Windows (shared)
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://download.pytorch.org/libtorch/cpu/libtorch-win-shared-with-deps-2.2.0.zip" -OutFile libtorch.zip
          Expand-Archive libtorch.zip -DestinationPath C:\libtorch
      - name: Set LIBTORCH env
        shell: pwsh
        run: |
          echo "LIBTORCH=C:\\libtorch" >> $env:GITHUB_ENV
          echo "LIBTORCH_LIB_DIR=C:\\libtorch\\lib" >> $env:GITHUB_ENV
          echo "PATH=C:\\libtorch\\bin;${env:PATH}" >> $env:GITHUB_ENV
          # Add lib path to LIB env for MSVC linking
          echo "LIB=$env:LIB;C:\\libtorch\\lib" >> $env:GITHUB_ENV
          # Ensure MSVC toolchain is used
          rustup default stable-x86_64-pc-windows-msvc || true
      - name: Install Microsoft Visual C++ Redistributable (vc_redist)
        shell: pwsh
        run: |
          $url = 'https://aka.ms/vs/17/release/vc_redist.x64.exe'
          Write-Host "Downloading $url..."
          Invoke-WebRequest -Uri $url -OutFile vc_redist.x64.exe
          Write-Host "Installing vc_redist.x64.exe..."
          Start-Process .\vc_redist.x64.exe -ArgumentList "/install","/quiet","/norestart" -Wait
          Write-Host "vc_redist installation attempted"
      - name: Install Visual Studio Build Tools (optional, may increase job time)
        shell: pwsh
        run: |
          Write-Host "Installing Visual Studio 2022 Build Tools via Chocolatey"
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --includeRecommended --passive" -y
      - name: Run cargo test (with_tch)
        shell: pwsh
        run: |
          cargo test --features "with_tch" --verbose --workspace
