name: CI (Default + openblas)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libopenblas-dev
      - name: Build and test (default)
        run: |
          cargo test --workspace --all-features --verbose
      - name: Setup Python and maturin
        run: |
          python -V
          pip install --upgrade pip
          pip install maturin
      - name: Build and run Python smoke test
        run: |
          maturin develop --release
          python -V
          python tests/python_smoke_test.py
      - name: Build and test with openblas feature (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cargo build --features openblas --verbose
          cargo test --features openblas --verbose
      - name: Verify matmul correctness (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Run the specific matmul forward unit test to verify BLAS correctness
          cargo test test_matmul_forward --features openblas -- --nocapture
          # Run the small example that exercises cblas_sgemm as an extra check
          cargo run --example blas_check --features openblas
      - name: Build and test with openblas feature (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $env:OPENBLAS_DIR = "${{ github.workspace }}\OpenBLAS-0.3.30-x64-64"
          $env:PATH = "$env:OPENBLAS_DIR\bin;$env:PATH"
          # Ensure the LIB environment variable includes the OpenBLAS lib directory for MSVC
          $env:LIB = "$env:OPENBLAS_DIR\lib;$env:LIB"
          try {
            Write-Host "Attempting build with prebuilt OpenBLAS"
            cargo build --features openblas --verbose
            cargo test --features openblas --verbose
          } catch {
            Write-Host "Prebuilt OpenBLAS build failed. Trying build with blas-src (build from source)."
            Remove-Item Env:OPENBLAS_DIR -ErrorAction SilentlyContinue
            cargo build --features openblas --verbose
            cargo test --features openblas --verbose
          }
      - name: Verify matmul correctness (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $env:OPENBLAS_DIR = "${{ github.workspace }}\OpenBLAS-0.3.30-x64-64"
          $env:PATH = "$env:OPENBLAS_DIR\bin;$env:PATH"
          $env:LIB = "$env:OPENBLAS_DIR\lib;$env:LIB"
          cargo test test_matmul_forward --features openblas -- --nocapture
          # Skip example run on Windows for now due to platform-specific linking; use a unit test instead

  bench:
    name: Benchmark (matmul_bench + openblas)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y libopenblas-dev
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      - name: Run matmul bench
        env:
          CI_BENCH: "1"
        run: |
          # Run a subset of benches for CI to limit runtime, but include the OpenBLAS feature
          # The bench may produce an HTML/JSON output in target/criterion
          cargo bench --bench matmul_bench --features openblas
      - name: Run regression check vs baseline
        run: |
          # The path below should be created by Criterion: bp = target/criterion/matmul/matmul_50x50/new/estimates.json
          NEW=target/criterion/matmul/matmul_50x50/new/estimates.json
          if [ -f "$NEW" ]; then
            python3 ci/compare_criterion_reports.py ci/baseline/matmul_50x50_estimates.json "$NEW" "matmul_50x50" 15
          else
            echo "Bench result file $NEW not found; skip regression check"
          fi
      - name: Upload Criterion reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: criterion-report
          path: target/criterion
